<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BestFlowers - Elegant Catalog</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="particles"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <span class="flower-icon">ðŸŒ¸</span>
                <h1>BestFlowers</h1>
            </div>
            <button class="add-btn" id="openModal">
                <span>+</span> Add Flower
            </button>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h2 class="hero-title">Curate Your Perfect</h2>
            <h2 class="hero-title gradient-text">Floral Collection</h2>
            <p class="hero-subtitle">Create, customize, and showcase the most exquisite flowers</p>
        </div>
        <div class="hero-decoration">
            <div class="floating-flower">ðŸŒº</div>
            <div class="floating-flower">ðŸŒ¹</div>
            <div class="floating-flower">ðŸŒ·</div>
            <div class="floating-flower">ðŸŒ»</div>
        </div>
    </section>

    <!-- Flower Catalog -->
    <section class="catalog">
        <div class="container">
            <div class="catalog-header">
                <h3>Your Flower Catalog</h3>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid">Grid</button>
                    <button class="view-btn" data-view="list">List</button>
                </div>
            </div>
            <div class="flower-grid" id="flowerGrid">
                <!-- Flowers will be dynamically added here -->
            </div>
        </div>
    </section>

    <!-- Add/Edit Flower Modal -->
    <div class="modal" id="flowerModal">
        <div class="modal-overlay" id="closeModal"></div>
        <div class="modal-content">
            <button class="modal-close" id="closeModalBtn">&times;</button>
            <h2 class="modal-title">Add New Flower</h2>
            <form id="flowerForm">
                <input type="hidden" id="flowerId">
                
                <div class="form-group">
                    <label for="flowerName">Flower Name</label>
                    <input type="text" id="flowerName" placeholder="e.g., Royal Rose" required>
                </div>

                <div class="form-group">
                    <label for="flowerEmoji">Emoji (optional if image is uploaded)</label>
                    <input type="text" id="flowerEmoji" placeholder="ðŸŒ¹" maxlength="2">
                </div>

                <div class="form-group">
                    <label for="flowerImage">Flower Image</label>
                    <input type="file" id="flowerImage" accept="image/*" class="file-input">
                    <div class="image-preview" id="imagePreview">
                        <span class="preview-placeholder">No image selected</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="flowerColor">Color</label>
                    <input type="text" id="flowerColor" placeholder="e.g., Deep Red" required>
                </div>

                <div class="form-group">
                    <label for="flowerPrice">Price</label>
                    <input type="number" id="flowerPrice" placeholder="29.99" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="flowerDescription">Description</label>
                    <textarea id="flowerDescription" rows="4" placeholder="Describe the beauty of this flower..." required></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Flower</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC2vWF39kInusipNwlq7sbwelIgtLf8RjM",
            authDomain: "bestflowers-5ba11.firebaseapp.com",
            projectId: "bestflowers-5ba11",
            storageBucket: "bestflowers-5ba11.firebasestorage.app",
            messagingSenderId: "1049452243750",
            appId: "1:1049452243750:web:33abf9a4786f61f05a6fe7",
            measurementId: "G-B6MJ3H49G9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global state
        let flowers = [];
        let editingFlowerId = null;

        // DOM Elements
        const modal = document.getElementById('flowerModal');
        const flowerForm = document.getElementById('flowerForm');
        const flowerGrid = document.getElementById('flowerGrid');
        const openModalBtn = document.getElementById('openModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalOverlay = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');

        // Modal handlers
        openModalBtn.addEventListener('click', () => {
            editingFlowerId = null;
            flowerForm.reset();
            document.getElementById('imagePreview').innerHTML = '<span class="preview-placeholder">No image selected</span>';
            document.querySelector('.modal-title').textContent = 'Add New Flower';
            modal.classList.add('active');
        });

        // Image preview handler
        document.getElementById('flowerImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        [closeModalBtn, closeModalOverlay, cancelBtn].forEach(el => {
            el.addEventListener('click', () => {
                modal.classList.remove('active');
            });
        });

        // Load flowers from Firestore
        async function loadFlowers() {
            try {
                const flowersQuery = query(collection(db, 'flowers'), orderBy('order', 'asc'));
                const querySnapshot = await getDocs(flowersQuery);
                flowers = [];
                querySnapshot.forEach((doc) => {
                    flowers.push({ id: doc.id, ...doc.data() });
                });
                renderFlowers();
            } catch (error) {
                console.error("Error loading flowers:", error);
            }
        }

        // Render flowers
        function renderFlowers() {
            flowerGrid.innerHTML = '';
            flowers.forEach((flower, index) => {
                const flowerCard = createFlowerCard(flower, index);
                flowerGrid.appendChild(flowerCard);
            });

            // Add animation delay
            document.querySelectorAll('.flower-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // Create flower card
        function createFlowerCard(flower, index) {
            const card = document.createElement('div');
            card.className = 'flower-card';
            
            const imageOrEmoji = flower.imageUrl 
                ? `<div class="flower-image"><img src="${flower.imageUrl}" alt="${flower.name}"></div>`
                : `<div class="flower-emoji">${flower.emoji || 'ðŸŒ¸'}</div>`;
            
            card.innerHTML = `
                <div class="flower-card-header">
                    ${imageOrEmoji}
                    <div class="flower-actions">
                        <button class="action-btn move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="action-btn move-down" data-index="${index}" ${index === flowers.length - 1 ? 'disabled' : ''}>â†“</button>
                    </div>
                </div>
                <div class="flower-card-body">
                    <h3 class="flower-name">${flower.name}</h3>
                    <p class="flower-color">${flower.color}</p>
                    <p class="flower-description">${flower.description}</p>
                    <div class="flower-price">$${flower.price}</div>
                </div>
                <div class="flower-card-footer">
                    <button class="btn-edit" data-id="${flower.id}">Edit</button>
                    <button class="btn-delete" data-id="${flower.id}">Delete</button>
                </div>
            `;

            // Event listeners
            card.querySelector('.btn-edit').addEventListener('click', () => editFlower(flower));
            card.querySelector('.btn-delete').addEventListener('click', () => deleteFlower(flower.id));
            card.querySelector('.move-up')?.addEventListener('click', () => moveFlower(index, -1));
            card.querySelector('.move-down')?.addEventListener('click', () => moveFlower(index, 1));

            return card;
        }

        // Add/Update flower
        flowerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                let imageUrl = editingFlowerId ? flowers.find(f => f.id === editingFlowerId).imageUrl : null;
                
                // Upload image if selected
                const imageFile = document.getElementById('flowerImage').files[0];
                if (imageFile) {
                    const imageRef = ref(storage, `flowers/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(imageRef, imageFile);
                    imageUrl = await getDownloadURL(imageRef);
                    
                    // Delete old image if updating
                    if (editingFlowerId) {
                        const oldFlower = flowers.find(f => f.id === editingFlowerId);
                        if (oldFlower.imageUrl) {
                            try {
                                const oldImageRef = ref(storage, oldFlower.imageUrl);
                                await deleteObject(oldImageRef);
                            } catch (err) {
                                console.log('Could not delete old image:', err);
                            }
                        }
                    }
                }
                
                const flowerData = {
                    name: document.getElementById('flowerName').value,
                    emoji: document.getElementById('flowerEmoji').value || 'ðŸŒ¸',
                    color: document.getElementById('flowerColor').value,
                    price: parseFloat(document.getElementById('flowerPrice').value),
                    description: document.getElementById('flowerDescription').value,
                    order: editingFlowerId ? flowers.find(f => f.id === editingFlowerId).order : flowers.length,
                    imageUrl: imageUrl || null
                };

                if (editingFlowerId) {
                    await updateDoc(doc(db, 'flowers', editingFlowerId), flowerData);
                } else {
                    await addDoc(collection(db, 'flowers'), flowerData);
                }
                
                modal.classList.remove('active');
                flowerForm.reset();
                document.getElementById('imagePreview').innerHTML = '<span class="preview-placeholder">No image selected</span>';
                loadFlowers();
                showNotification('Flower saved successfully! ðŸŒ¸');
            } catch (error) {
                console.error("Error saving flower:", error);
                showNotification('Error saving flower: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Flower';
            }
        });

        // Edit flower
        function editFlower(flower) {
            editingFlowerId = flower.id;
            document.getElementById('flowerName').value = flower.name;
            document.getElementById('flowerEmoji').value = flower.emoji || '';
            document.getElementById('flowerColor').value = flower.color;
            document.getElementById('flowerPrice').value = flower.price;
            document.getElementById('flowerDescription').value = flower.description;
            
            // Show existing image preview
            if (flower.imageUrl) {
                document.getElementById('imagePreview').innerHTML = `<img src="${flower.imageUrl}" alt="Current image">`;
            } else {
                document.getElementById('imagePreview').innerHTML = '<span class="preview-placeholder">No image selected</span>';
            }
            
            document.querySelector('.modal-title').textContent = 'Edit Flower';
            modal.classList.add('active');
        }

        // Delete flower
        async function deleteFlower(id) {
            if (confirm('Are you sure you want to delete this flower?')) {
                try {
                    const flower = flowers.find(f => f.id === id);
                    
                    // Delete image from storage if exists
                    if (flower.imageUrl) {
                        try {
                            const imageRef = ref(storage, flower.imageUrl);
                            await deleteObject(imageRef);
                        } catch (err) {
                            console.log('Could not delete image:', err);
                        }
                    }
                    
                    await deleteDoc(doc(db, 'flowers', id));
                    loadFlowers();
                    showNotification('Flower deleted successfully!');
                } catch (error) {
                    console.error("Error deleting flower:", error);
                    showNotification('Error deleting flower', 'error');
                }
            }
        }

        // Move flower up/down
        async function moveFlower(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= flowers.length) return;

            const temp = flowers[index];
            flowers[index] = flowers[newIndex];
            flowers[newIndex] = temp;

            // Update order in Firestore
            try {
                await updateDoc(doc(db, 'flowers', flowers[index].id), { order: index });
                await updateDoc(doc(db, 'flowers', flowers[newIndex].id), { order: newIndex });
                renderFlowers();
            } catch (error) {
                console.error("Error reordering flowers:", error);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                flowerGrid.className = btn.dataset.view === 'list' ? 'flower-list' : 'flower-grid';
            });
        });

        // Create floating particles
        function createParticles() {
            const particles = document.querySelector('.particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particles.appendChild(particle);
            }
        }

        // Initialize
        createParticles();
        loadFlowers();
    </script>
</body>
</html>