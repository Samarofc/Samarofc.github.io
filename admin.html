<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BestFlowers - Admin Panel</title>
    <link rel="stylesheet" href="./styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="particles"></div>

    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <span class="flower-icon">ðŸŒ¸</span>
                <h1>BestFlowers Admin</h1>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px;">Login</button>
            </form>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>

    <!-- Admin Panel (Hidden until logged in) -->
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="logo">
                    <span class="flower-icon">ðŸŒ¸</span>
                    <h1>BestFlowers Admin</h1>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="add-btn" id="openModal">
                        <span>+</span> Add Flower
                    </button>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero" style="padding: 40px 0;">
            <div class="hero-content">
                <h2 class="hero-title">Manage Your</h2>
                <h2 class="hero-title gradient-text">Flower Collection</h2>
            </div>
        </section>

        <!-- Flower Catalog -->
        <section class="catalog">
            <div class="container">
                <div class="catalog-header">
                    <h3>Manage Flowers</h3>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid">Grid</button>
                        <button class="view-btn" data-view="list">List</button>
                    </div>
                </div>
                <div class="flower-grid" id="flowerGrid">
                    <!-- Flowers will be dynamically added here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Add/Edit Flower Modal -->
    <div class="modal" id="flowerModal">
        <div class="modal-overlay" id="closeModal"></div>
        <div class="modal-content">
            <button class="modal-close" id="closeModalBtn">&times;</button>
            <h2 class="modal-title">Add New Flower</h2>
            <form id="flowerForm">
                <input type="hidden" id="flowerId">
                
                <div class="form-group">
                    <label for="flowerName">Flower Name</label>
                    <input type="text" id="flowerName" placeholder="e.g., Royal Rose" required>
                </div>

                <div class="form-group">
                    <label for="flowerEmoji">Emoji (optional if image is uploaded)</label>
                    <input type="text" id="flowerEmoji" placeholder="ðŸŒ¹" maxlength="2">
                </div>

                <div class="form-group">
                    <label for="flowerImage">Flower Image</label>
                    <input type="file" id="flowerImage" accept="image/*" class="file-input">
                    <div class="image-preview" id="imagePreview">
                        <span class="preview-placeholder">No image selected</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="flowerColor">Color</label>
                    <input type="text" id="flowerColor" placeholder="e.g., Deep Red" required>
                </div>

                <div class="form-group">
                    <label for="flowerPrice">Price (â‚¹)</label>
                    <input type="number" id="flowerPrice" placeholder="299" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="flowerDescription">Description</label>
                    <textarea id="flowerDescription" rows="4" placeholder="Describe the beauty of this flower..." required></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Flower</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEaaMDgDZ3UK4o9qBdqOiZx8gKX5k5-LU",
            authDomain: "bestflowers-test.firebaseapp.com",
            projectId: "bestflowers-test",
            storageBucket: "bestflowers-test.firebasestorage.app",
            messagingSenderId: "59558482984",
            appId: "1:59558482984:web:592d19fa805ce21c64511d",
            measurementId: "G-HT5VYHC4XY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Admin credentials (in production, use proper authentication)
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "bestflowers123";

        // Global state
        let flowers = [];
        let editingFlowerId = null;
        let isLoggedIn = false;

        // Check if already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            showAdminPanel();
        }

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const loginContainer = document.getElementById('loginContainer');
        const adminPanel = document.getElementById('adminPanel');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const modal = document.getElementById('flowerModal');
        const flowerForm = document.getElementById('flowerForm');
        const flowerGrid = document.getElementById('flowerGrid');
        const openModalBtn = document.getElementById('openModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalOverlay = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');

        // Login handler
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                loginError.textContent = 'Invalid username or password';
                loginError.style.color = '#f44336';
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('adminLoggedIn');
            adminPanel.style.display = 'none';
            loginContainer.style.display = 'flex';
            loginError.textContent = '';
            loginForm.reset();
        });

        function showAdminPanel() {
            isLoggedIn = true;
            loginContainer.style.display = 'none';
            adminPanel.style.display = 'block';
            loadFlowers();
        }

        // Modal handlers
        openModalBtn.addEventListener('click', () => {
            editingFlowerId = null;
            flowerForm.reset();
            const previewElement = document.getElementById('imagePreview');
            previewElement.innerHTML = '<span class="preview-placeholder">No image selected</span>';
            delete previewElement.dataset.imageData;
            document.querySelector('.modal-title').textContent = 'Add New Flower';
            modal.classList.add('active');
        });

        [closeModalBtn, closeModalOverlay, cancelBtn].forEach(el => {
            el.addEventListener('click', () => {
                modal.classList.remove('active');
            });
        });

        // Image preview and compression handler
        document.getElementById('flowerImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const compressedBase64 = await compressImage(file);
                    document.getElementById('imagePreview').innerHTML = `<img src="${compressedBase64}" alt="Preview">`;
                    document.getElementById('imagePreview').dataset.imageData = compressedBase64;
                } catch (error) {
                    showNotification('Error processing image: ' + error.message, 'error');
                }
            }
        });

        // Compress image to base64 (under 1MB)
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 1200;
                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.8;
                        let base64 = canvas.toDataURL('image/jpeg', quality);
                        
                        while (base64.length > 1000000 && quality > 0.1) {
                            quality -= 0.1;
                            base64 = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        if (base64.length > 1000000) {
                            reject(new Error('Image too large even after compression'));
                        } else {
                            resolve(base64);
                        }
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        // Load flowers from Firestore
        async function loadFlowers() {
            try {
                const flowersQuery = query(collection(db, 'flowers'), orderBy('order', 'asc'));
                const querySnapshot = await getDocs(flowersQuery);
                flowers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    flowers.push({ 
                        id: doc.id, 
                        name: data.name || '',
                        emoji: data.emoji || 'ðŸŒ¸',
                        color: data.color || '',
                        price: data.price || 0,
                        description: data.description || '',
                        order: data.order || 0,
                        imageBase64: data.imageBase64 || null
                    });
                });
                renderFlowers();
            } catch (error) {
                console.error("Error loading flowers:", error);
                showNotification('Error loading flowers', 'error');
            }
        }

        // Render flowers
        function renderFlowers() {
            flowerGrid.innerHTML = '';
            flowers.forEach((flower, index) => {
                const flowerCard = createFlowerCard(flower, index);
                flowerGrid.appendChild(flowerCard);
            });

            document.querySelectorAll('.flower-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // Create flower card with admin controls
        function createFlowerCard(flower, index) {
            const card = document.createElement('div');
            card.className = 'flower-card';
            
            const imageOrEmoji = flower.imageBase64 
                ? `<div class="flower-image"><img src="${flower.imageBase64}" alt="${flower.name}"></div>`
                : `<div class="flower-emoji">${flower.emoji || 'ðŸŒ¸'}</div>`;
            
            card.innerHTML = `
                <div class="flower-card-header">
                    ${imageOrEmoji}
                    <div class="flower-actions">
                        <button class="action-btn move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="action-btn move-down" data-index="${index}" ${index === flowers.length - 1 ? 'disabled' : ''}>â†“</button>
                    </div>
                </div>
                <div class="flower-card-body">
                    <h3 class="flower-name">${flower.name}</h3>
                    <p class="flower-color">${flower.color}</p>
                    <p class="flower-description">${flower.description}</p>
                    <div class="flower-price">â‚¹${flower.price}</div>
                </div>
                <div class="flower-card-footer">
                    <button class="btn-edit" data-id="${flower.id}">Edit</button>
                    <button class="btn-delete" data-id="${flower.id}">Delete</button>
                </div>
            `;

            // Event listeners
            card.querySelector('.btn-edit').addEventListener('click', () => editFlower(flower));
            card.querySelector('.btn-delete').addEventListener('click', () => deleteFlower(flower.id));
            card.querySelector('.move-up')?.addEventListener('click', () => moveFlower(index, -1));
            card.querySelector('.move-down')?.addEventListener('click', () => moveFlower(index, 1));

            return card;
        }

        // Add/Update flower
        flowerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                let imageBase64 = editingFlowerId ? flowers.find(f => f.id === editingFlowerId).imageBase64 : null;
                
                const previewElement = document.getElementById('imagePreview');
                if (previewElement.dataset.imageData) {
                    imageBase64 = previewElement.dataset.imageData;
                }
                
                const flowerData = {
                    name: document.getElementById('flowerName').value,
                    emoji: document.getElementById('flowerEmoji').value || 'ðŸŒ¸',
                    color: document.getElementById('flowerColor').value,
                    price: parseFloat(document.getElementById('flowerPrice').value),
                    description: document.getElementById('flowerDescription').value,
                    order: editingFlowerId ? flowers.find(f => f.id === editingFlowerId).order : Date.now(),
                    imageBase64: imageBase64 || null
                };

                if (editingFlowerId) {
                    await updateDoc(doc(db, 'flowers', editingFlowerId), flowerData);
                } else {
                    await addDoc(collection(db, 'flowers'), flowerData);
                }
                
                modal.classList.remove('active');
                flowerForm.reset();
                document.getElementById('imagePreview').innerHTML = '<span class="preview-placeholder">No image selected</span>';
                delete document.getElementById('imagePreview').dataset.imageData;
                loadFlowers();
                showNotification('Flower saved successfully! ðŸŒ¸');
            } catch (error) {
                console.error("Error saving flower:", error);
                showNotification('Error saving flower: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Flower';
            }
        });

        // Edit flower
        function editFlower(flower) {
            editingFlowerId = flower.id;
            document.getElementById('flowerName').value = flower.name;
            document.getElementById('flowerEmoji').value = flower.emoji || '';
            document.getElementById('flowerColor').value = flower.color;
            document.getElementById('flowerPrice').value = flower.price;
            document.getElementById('flowerDescription').value = flower.description;
            
            const previewElement = document.getElementById('imagePreview');
            if (flower.imageBase64) {
                previewElement.innerHTML = `<img src="${flower.imageBase64}" alt="Current image">`;
                previewElement.dataset.imageData = flower.imageBase64;
            } else {
                previewElement.innerHTML = '<span class="preview-placeholder">No image selected</span>';
                delete previewElement.dataset.imageData;
            }
            
            document.querySelector('.modal-title').textContent = 'Edit Flower';
            modal.classList.add('active');
        }

        // Delete flower
        async function deleteFlower(id) {
            if (confirm('Are you sure you want to delete this flower?')) {
                try {
                    await deleteDoc(doc(db, 'flowers', id));
                    loadFlowers();
                    showNotification('Flower deleted successfully!');
                } catch (error) {
                    console.error("Error deleting flower:", error);
                    showNotification('Error deleting flower', 'error');
                }
            }
        }

        // Move flower up/down
        async function moveFlower(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= flowers.length) return;

            const temp = flowers[index];
            flowers[index] = flowers[newIndex];
            flowers[newIndex] = temp;

            try {
                await updateDoc(doc(db, 'flowers', flowers[index].id), { order: index });
                await updateDoc(doc(db, 'flowers', flowers[newIndex].id), { order: newIndex });
                renderFlowers();
            } catch (error) {
                console.error("Error reordering flowers:", error);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                flowerGrid.className = btn.dataset.view === 'list' ? 'flower-list' : 'flower-grid';
            });
        });

        // Create floating particles
        function createParticles() {
            const particles = document.querySelector('.particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particles.appendChild(particle);
            }
        }

        createParticles();
    </script>
</body>
</html>
